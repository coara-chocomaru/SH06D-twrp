name: Recovery Build (Legacy)

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'MANIFEST_URL (if want to use SSH keys, use git@github.com:XXXXX)'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni'
      MANIFEST_BRANCH:
        description: 'MANIFEST_BRANCH'
        required: true
        default: 'twrp-4.4-deprecated'
      DEVICE_TREE_URL:
        description: 'DEVICE_TREE_URL'
        required: true
        default: 'https://github.com/coara-chocomaru/SH06D-twrp'
      DEVICE_TREE_BRANCH:
        description: 'DEVICE_TREE_BRANCH'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'DEVICE_PATH'
        required: true
        default: 'device/shrp/sh06d'
      DEVICE_NAME:
        description: 'DEVICE_NAME'
        required: true
        default: 'sh06d'
      MAKEFILE_NAME:
        description: 'MAKEFILE_NAME'
        required: true
        default: 'omni_sh06d'
      BUILD_TARGET:
        description: 'BUILD_TARGET'
        required: true
        default: 'recovery'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
    permissions:
      contents: write
    timeout-minutes: 360

    defaults:
      run:
        shell: bash -l {0}

    steps:
    - name: Display Run Parameters
      run: |
        echo "::group::User Environment Variables"
        echo "Manifest URL: ${{ github.event.inputs.MANIFEST_URL }}"
        echo "Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device Tree URL: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Device Tree Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Device Path: ${{ github.event.inputs.DEVICE_PATH }}"
        echo "Device Name: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Makefile Name: ${{ github.event.inputs.MAKEFILE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}.img"
        echo "::endgroup::"

    - name: Check Out
      uses: actions/checkout@v4

    - name: Prepare the environment (install packages)
      run: |
        set -euo pipefail
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends curl git unzip python2.7 sudo make python3 python3-distutils wget rsync build-essential bison flex libncurses5-dev lib32z1 zlib1g-dev bc ccache make gcc-multilib g++-multilib lib32readline-dev lib32z1-dev liblz4-tool libsdl1.2-dev libxml2 xsltproc lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev tar file openssh-client openjdk-8-jdk
        if command -v python2 >/dev/null 2>&1 && [ ! -e /usr/bin/python ]; then
        ln -sf /usr/bin/python2 /usr/bin/python || true
        fi
        update-alternatives --set java $(readlink -f /usr/bin/java) || true
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export PATH="$JAVA_HOME/bin:$PATH"

    - name: Setup Java (actions/setup-java)
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '8'

    - name: Setup SSH Keys (if using SSH URLs)
      if: ${{ startsWith(github.event.inputs.MANIFEST_URL, 'git@github.com') || startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@github.com') || (github.event.inputs.COMMON_TREE_URL != '' && startsWith(github.event.inputs.COMMON_TREE_URL, 'git@github.com')) }}
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Install repo
      run: |
        set -euo pipefail
        mkdir -p $HOME/bin
        curl -sSLo $HOME/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
        chmod a+x $HOME/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Initialize repo
      id: pwd
      run: |
        set -euo pipefail
        ln -s /usr/bin/python3 /usr/bin/python
        mkdir -p workspace
        cd workspace
        echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT
        git config --global user.name "github-actions[bot]"
        git config --global user.email "actions@github.com"
        repo init --depth=1 -u "${{ github.event.inputs.MANIFEST_URL }}" -b "${{ github.event.inputs.MANIFEST_BRANCH }}" || repo init --repo-branch=repo-1 -u "${{ github.event.inputs.MANIFEST_URL }}" -b "${{ github.event.inputs.MANIFEST_BRANCH }}"

    - name: Repo Sync
      run: |
        set -euo pipefail
        cd "${{ steps.pwd.outputs.workspace-folder }}"
        repo sync -c --no-clone-bundle --depth=1 -j$(nproc) || repo sync -j2 || true

    - name: Clone device tree
      run: |
        set -euo pipefail
        cd "${{ steps.pwd.outputs.workspace-folder }}"
        git clone --depth 1 -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" "${{ github.event.inputs.DEVICE_TREE_URL }}" "${{ github.event.inputs.DEVICE_PATH }}"

    - name: Clone common tree (optional)
      if: ${{ github.event.inputs.COMMON_TREE_URL != '' && github.event.inputs.COMMON_PATH != '' }}
      run: |
        set -euo pipefail
        cd "${{ steps.pwd.outputs.workspace-folder }}"
        git clone --depth 1 -b "${{ github.event.inputs.COMMON_TREE_BRANCH }}" "${{ github.event.inputs.COMMON_TREE_URL }}" "${{ github.event.inputs.COMMON_PATH }}"

    - name: Sync Device Dependencies (best-effort)
      run: |
        set -euo pipefail
        cd "${{ steps.pwd.outputs.workspace-folder }}"
        if [ -f "${GITHUB_WORKSPACE}/scripts/convert.sh" ]; then
          bash ${GITHUB_WORKSPACE}/scripts/convert.sh "${{ github.event.inputs.DEVICE_PATH }}".dependencies || true
          repo sync -j$(nproc) || true
        else
          true
        fi
      continue-on-error: true

    - name: Building recovery
      run: |
        set -euo pipefail
        cd "${{ steps.pwd.outputs.workspace-folder }}"
        source build/envsetup.sh || true
        export ALLOW_MISSING_DEPENDENCIES=true
        export EXPERIMENTAL_USE_JAVA8=1
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export PATH="$JAVA_HOME/bin:$PATH"
        combos=("${{ github.event.inputs.MAKEFILE_NAME }}-${{ github.event.inputs.DEVICE_NAME }}-eng" "${{ github.event.inputs.MAKEFILE_NAME }}_${{ github.event.inputs.DEVICE_NAME }}-eng" "${{ github.event.inputs.MAKEFILE_NAME }}-eng" "${{ github.event.inputs.DEVICE_NAME }}-eng" "${{ github.event.inputs.MAKEFILE_NAME }}")
        for c in "${combos[@]}"; do
          lunch "$c" && break || true
        done
        make clean || true
        make "${{ github.event.inputs.BUILD_TARGET }}"image -j$(nproc) || make -j1 "${{ github.event.inputs.BUILD_TARGET }}"image || true

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*vendor*.img
        name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}
          Device: ${{ github.event.inputs.DEVICE_NAME }}
          Target: ${{ github.event.inputs.BUILD_TARGET }}.img
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
